

<!DOCTYPE html>
<html lang="en_US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    

    

    <title>Why don't you see ghosts in galeras?</title>

    
    <meta content="/blog-test/img/ico/favicon.png" itemprop="image">
    <meta property="og:image" content="/blog-test/img/ico/favicon.png">
    <link rel="apple-touch-icon" href="/blog-test/img/ico/favicon.png">
    <link rel="icon" href="/blog-test/img/ico/favicon.ico" />
    <link rel="shortcut icon" href="/blog-test/img/ico/favicon.ico" />

    
    <meta name="theme-color" content="#3273dc">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700" rel="stylesheet">
    <!-- Bulma -->
    <link rel="stylesheet" href="/blog-test/css/bulma.min.css" />

    <!-- Font awesome -->
    <link rel="stylesheet" href="/blog-test/css/fontawesome.min.css" />

    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="/blog-test/css/main.min.css" />
  </head>

  <body>
    <div class="page-container">
      <div class="content-wrapper">
        
<!-- Navigation bar -->
<nav class="navbar is-link" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="/blog-test/">
      <i class="fas fa-terminal navbar-icon"></i>
      <span class="is-size-4">Another engineer web</span>
    </a>

    <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbar">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>

  <div id="navbar" class="navbar-menu">
    <div class="navbar-end">
      <a class="navbar-item" href="/blog-test/">
        <span class="icon">
          <i class="fas fa-bars"></i>
        </span>
        <span>Blog</span>
      </a>
      <a class="navbar-item" href="/blog-test/en/publications/">
        <span class="icon">
          <i class="fas fa-file-alt"></i>
        </span>
        <span>Publications</span>
      </a>
      <a class="navbar-item" href="/blog-test/en/about_me/">
        <span class="icon">
          <i class="fas fa-info"></i>
        </span>
        <span>About me</span>
      </a>
      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">
          <span class="icon">
            <i class="fas fa-flag"></i>
          </span>
          <span>Language</span>
        </a>

        <div class="navbar-dropdown">
          
            <a class="navbar-item" href="/blog-test/en/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/">
              ðŸ‡ºðŸ‡¸ English
            </a>
          
            <a class="navbar-item" href="/blog-test/es/blog/2019-05-12-por-que-no-ves-fantasmas-en-galeras/">
              ðŸ‡ªðŸ‡¸ EspaÃ±ol
            </a>
          
        </div>
      </div>
    </div>
  </div>
</nav>


        <noscript>
          <p class="enable-js">Enable JavaScript in your browser for a better experience.</p>
        </noscript>

        <div class="container">
          
<!-- START ARTICLE FEED -->
<section class="articles">
  <div class="column is-8 is-offset-2">
    <div class="card article">
      <div class="card-content">
        <div>
  
    <p class="title has-text-centered">Why don't you see ghosts in galeras?</p>
  
  <p class="subtitle is-6 has-text-centered">May 12, 2019</p>
  <div class="tags has-addons level-item">
    
      <span class="tag is-rounded is-info">MySQL</span>
    
      <span class="tag is-rounded is-info">Schema changes</span>
    
    <span class="tag">7 min read</span>
  </div>
</div>
<br>
<div class="content has-text-justified article-body">
  <p>The development of software sometimes implies changes that affect the data model but such modifications have a series of problems such as the inability to stop the system or the volume of data to be reorganized.</p>

<p>In this post I want to talk about the existing tools for database schema change in MySQL, what limitations do those tools have if you use <code>Galera</code> for replication and how I have adapted <code>gh-ost</code>, the GitHub schema change tool, to be able to use it with <code>Galera</code>.</p>

<h3 id="schema-changes">Schema changes</h3>

<p>In MySQL it is possible to make database changes in two main ways:</p>

<ul>
<li>Using the <code>ALTER</code> operation of MySQL; it is the simplest way but it does not allow to abort the process in case of necessity and except for certain operations, it prevents the concurrent use of the table to be modified during the process.</li>
<li>Through the use of third party tools that allow a greater control of the process although with certain restrictions. Some of these tools can be <a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html">pt-osc</a>, <a href="https://github.com/facebookincubator/OnlineSchemaChange">OnlineSchemaChange</a> or <a href="https://github.com/github/gh-ost">gh-ost</a>.</li>
</ul>

<p>These two methods are also applicable if you use <code>Galera</code> although, because it follows a master-master approach, it has some peculiarities to apply database changes, both through the operations provided by MySQL and by the third party tools.</p>

<h3 id="galera">Galera</h3>

<p><code>Galera</code> is a plug-in for InnoDB that allows a multi-master synchronous replication. This approach allows, unlike normal MySQL replication, that all the nodes in the clister have the same data and, therefore, do writes in all the nodes of the cluster sacrificing some performance.</p>

<div class="columns"> <div class="column is-8-mobile is-offset-2-mobile is-6-tablet is-offset-3-tablet"> <div class="post-image-container"> <div class="image post-image"> <div class="lazy-hide lazy-container"> <img alt="Galera replication" class="lazy lazy-blur" data-srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.190px.png 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.480px.png 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.674px.png 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.836px.png 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.975px.png 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.1109px.png 5545w" data-src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.190px.png" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.preview.png" /> </div> <noscript> <div class="lazy-container"> <img alt="Galera replication" class="" srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.190px.png 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.480px.png 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.674px.png 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.836px.png 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.975px.png 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.1109px.png 5545w" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/galera_replication.190px.png" /> </div> </noscript> </div> <div class="image-caption">Galera replication. Image from <a href="https://severalnines.com/resources/tutorials/galera-cluster-mysql-tutorial">severalnines</a></div> </div>  </div> </div>

<p>Schema changes are <a href="https://galeracluster.com/library/documentation/schema-upgrades.html">special operations</a> in <code>Galera</code>, since they modify the database and are non-transactional. <code>Galera</code> has two modes for applying database changes using the <code>ALTER</code> operation:</p>

<ul>
<li><strong>TOI</strong><sup class="footnote-ref" id="fnref-1"><a href="#fn-1">1</a></sup> are schema changes made in all nodes of the cluster in the same total order sequence, preventing other transactions from being applied during the operation.</li>
<li><strong>RSU</strong><sup class="footnote-ref" id="fnref-2"><a href="#fn-2">2</a></sup> are schema changes that are executed locally, affecting only the node in which they are executed. The changes are not replicated to the rest of the cluster.</li>
</ul>

<p>These two modes have a number of drawbacks: the <strong>TOI</strong> operations block the whole cluster during the schema change while the <strong>RSU</strong> operations can leave the cluster in an inconsistent state if the binary log in <code>ROW</code> format is not compatible between schemas.</p>

<p>Regarding the use of third party tools, <code>Galera</code> has a series of <a href="https://www.fromdual.com/limitations-of-galera-cluster">limitations</a> among which is the lack of support for table locking, an operation necessary in <code>OnlineSchemaChange</code> and <code>gh-ost</code> tools to apply the last events due to its asynchronous nature, a problem that <code>pt-osc</code> does not have because it is synchronous due to the use of triggers.</p>

<p>Although <code>pt-osc</code> is compatible with <code>Galera</code>, the use of triggers presents a number of risks because it is not possible to stop the operation completely if necessary and the use of triggers adds an extra load to the database. Therefore, to allow the use of <code>gh-ost</code> in <code>Galera</code>, it is necessary to investigate why it need the use of <code>LOCK TABLES</code> and look for an alternative approach.</p>

<h3 id="gh-ost">gh-ost</h3>

<p><a href="https://github.com/github/gh-ost"><em>gh-ost</em></a> is GitHub's tool for applying online schema changes and has interesting advantages over other existing tools. One of its main features is that it doesn't use triggers to synchronize the changes of the original table with the ghost table <sup class="footnote-ref" id="fnref-3"><a href="#fn-3">3</a></sup> but the binlogs of MySQL and therefore it really allows to stop the migration completely if necessary.</p>

<div class="columns"> <div class="column is-8-mobile is-offset-2-mobile is-6-tablet is-offset-3-tablet"> <div class="post-image-container"> <div class="image post-image"> <div class="lazy-hide lazy-container"> <img alt="The gh-ost logo" class="lazy lazy-blur" data-srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.190px.png 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.480px.png 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.674px.png 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.836px.png 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.975px.png 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.1109px.png 5545w" data-src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.190px.png" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.preview.png" /> </div> <noscript> <div class="lazy-container"> <img alt="The gh-ost logo" class="" srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.190px.png 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.480px.png 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.674px.png 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.836px.png 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.975px.png 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.1109px.png 5545w" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/gh-ost.190px.png" /> </div> </noscript> </div> <div class="image-caption">The gh-ost logo</div> </div>  </div> </div>

<p>The reason that prevents using <code>gh-ost</code> with <code>Galera</code> is that, in order to do the <a href="https://github.com/github/gh-ost/blob/master/doc/cut-over.md">cut-over</a> phase, <code>gh-ost</code> makes use of the <a href="https://dev.mysql.com/doc/refman/8.0/en/lock-tables.html">lock</a> operation, that it is not supported in <code>Galera</code>.</p>

<h4 id="cut-over">Cut-over</h4>

<p>In the documentation of <code>gh-ost</code> the cut-over phase is defined as <code>the final major step of the migration</code> and its goal is to replace the ghost table with the original one. For this purpose, it is necessary that both tables have the same records applied at the time of the swap, otherwise data would be lost in the migration process.</p>

<p>Unlike other online schema change tools such as <code>pt-osc</code>, <code>gh-ost</code> does not delegate in the database the application of the modified records during the migration and, therefore, it needs to momentarily block the writes in the original table until all pending changes in the binlog are applied, that is where the use of the lock operation in the original table is necessary.</p>

<h4 id="lock-tables">LOCK TABLES</h4>

<p>The first approach that may come to mind is that although the lock operation in <code>Galera</code> does not allow blocking access to a table in all nodes atomically, it does accept blocking access to a particular node, so it may be possible to apply <code>LOCK TABLES</code> manually in all nodes. After some research and a couple of tests this approach is discarded for several reasons:</p>

<ul>
<li>The atomic cut-over algorithm of <code>gh-ost</code> needs the use of several independent connections to work and although it guarantees to leave the cluster in a consistent state in the case of errors in the connections, this premise is no longer true if a <code>LOCK TABLES</code> must be applied for each node. If you want to know how <code>gh-ost</code> strategy to apply the atomic cut-over works, I recommend you to read <a href="https://github.com/github/gh-ost/issues/82">Issue #82</a>.</li>
<li>As can be seen in <a href="https://jira.mariadb.org/browse/MDEV-12647">MDEV-12647</a>, it is quite possible to leave some of the nodes hanging when using the <code>LOCK TABLES</code> on each node.</li>
</ul>

<p>Therefore, the use of <code>LOCK TABLES</code> is discarded and it is necessary to analyze other existing solutions to perform schema migrations without loss of service and that if they allow its use with the <code>Galera</code>, that is where <code>pt-osc</code> comes into play.</p>

<div class="columns"> <div class="column is-8-mobile is-offset-2-mobile is-6-tablet is-offset-3-tablet"> <div class="post-image-container"> <div class="image post-image"> <div class="lazy-hide lazy-container"> <img alt="Man thinking" class="lazy lazy-blur" data-srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.190px.jpg 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.480px.jpg 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.674px.jpg 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.836px.jpg 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.975px.jpg 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.1109px.jpg 5545w" data-src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.190px.jpg" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.preview.png" /> </div> <noscript> <div class="lazy-container"> <img alt="Man thinking" class="" srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.190px.jpg 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.480px.jpg 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.674px.jpg 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.836px.jpg 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.975px.jpg 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.1109px.jpg 5545w" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/brainstorming.190px.jpg" /> </div> </noscript> </div> <div class="image-caption">Man thinking. Image from <a href="https://www.pexels.com/@startup-stock-photos">Startup Stock Photos</a></div> </div>  </div> </div>

<h3 id="pt-osc">pt-osc</h3>

<p><a href="https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html">pt-osc</a> is a Percona tool that allows to perform schema migrations without loss of service compatible with <code>Galera</code> and it is based on delegating to the database the data modified during the migration using triggers, this way it is ensured that the changes of the original table are synchronized with the ghost table. If you want to know how to ensure consistency I recommend you to read this answer from <a href="https://dba.stackexchange.com/a/93515">StackExchange</a>.</p>

<div class="columns"> <div class="column is-8-mobile is-offset-2-mobile is-6-tablet is-offset-3-tablet"> <div class="post-image-container"> <div class="image post-image"> <div class="lazy-hide lazy-container"> <img alt="The Percona toolkit logo" class="lazy lazy-blur" data-srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.190px.jpg 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.480px.jpg 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.674px.jpg 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.836px.jpg 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.975px.jpg 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.1109px.jpg 5545w" data-src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.190px.jpg" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.preview.png" /> </div> <noscript> <div class="lazy-container"> <img alt="The Percona toolkit logo" class="" srcset="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.190px.jpg 190w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.480px.jpg 480w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.674px.jpg 1348w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.836px.jpg 4180w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.975px.jpg 4875w, /blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.1109px.jpg 5545w" src="/blog-test/img/blog/2019-05-12-why-dont-you-see-ghosts-in-galeras/percona_toolkit.190px.jpg" /> </div> </noscript> </div> <div class="image-caption">The Percona toolkit logo</div> </div>  </div> </div>

<h3 id="solution-proposed">Solution proposed</h3>

<p>Therefore, if it is possible to perform a consistent migration using triggers it may be possible to use them even if only for the cut-over phase. To do this, it is possible to raise a new cut-over strategy, the procedure for which is as follows:</p>

<ul>
<li>At the time of starting the cut-over an event is injected in the binlog to notify <code>gh-ost</code> to stop writing the new records in the ghost table but to keep reading them from the binlog.</li>
<li>Once the <code>gh-ost</code> event is received it stops applying the events but stores the values according to the unique key used
during the migration.</li>
<li>The necessary triggers are created to synchronize the new records between the original table and the ghost one.</li>
<li>A new event is injected into the binlog to notify that the triggers have been created.</li>
<li>Once this second event is received, the binlog is no longer read and therefore alto it stop storage the values according to the unique key.</li>
<li>The records between the two events may be inconsistent since some recors of the
binlog have not been applied. To solve this problem, a clean-up phase is performed, which consists of removing them from the ghost table is exists and inserting them again from the original table.</li>
<li>Once the events have been sanitized, both tables are consistent, so it is possible to use the <code>RENAME TABLE</code> operation to swap the original table with the ghost one in an atomic way.</li>
<li>After that operation or in the case of failure, the triggers are removed.</li>
</ul>

<h3 id="results-and-conclusion">Results and conclusion</h3>

<p>Once I proposed a solution I implemented the necessary changes to the <code>gh-ost</code> code and after a couple of weeks of testing we started using it in production with very good results, so I created the pull request <a href="https://github.com/github/gh-ost/pull/780">#780</a>.</p>

<p>Regarding the conclusion, even if <code>gh-ost</code> is considered triggerless, the life of the necessary triggers will be equal to the time it takes to apply the pending changes to the binlog and clean up the entries that may be inconsistent, which will be just a few seconds in the worst case, so it is considered acceptable.</p>

<div class="footnotes">
<hr />
<ol>
<li id="fn-1">
<p>Total Order Isolation.&#160;<a href="#fnref-1" class="footnoteBackLink" title="Jump back to footnote 1 in the text.">&#8617;</a></p>
</li>

<li id="fn-2">
<p>Rolling Schema Upgrade.&#160;<a href="#fnref-2" class="footnoteBackLink" title="Jump back to footnote 2 in the text.">&#8617;</a></p>
</li>

<li id="fn-3">
<p>With ghost table I refer the table where the schema changes have been applied and that needs to be filled in with the data of the original one.&#160;<a href="#fnref-3" class="footnoteBackLink" title="Jump back to footnote 3 in the text.">&#8617;</a></p>
</li>
</ol>
</div>

</div>

      </div>
    </div>
  </div>
</section>
<!-- END ARTICLE FEED -->

        </div>
      </div>

      <footer class="footer">
        <div class="content has-text-centered">
          <p>Â© Juan Manuel Fdez 2020. Made with curiosity, coffee and neovim.</p>
          <div>
            <a href="/blog-test/en/rss.xml">
              <span class="icon">
                <i class="fas fa-rss"></i>
              </span>
              <span>RSS</span>
            </a>
          </div>
        </div>
      </footer>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script defer src="/blog-test/vendor/jquery/jquery.min.js"></script>

    <!-- Plugin JavaScript -->
    <script defer src="/blog-test/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script defer src="/blog-test/vendor/jquery-lazy/jquery.lazy.min.js"></script>

    <!-- Custom scripts for this template -->
    <script defer src="/blog-test/js/main.min.js"></script>
  </body>
</html>